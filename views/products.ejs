<% layout('layout') %>
<% script('/jquery-1.8.2.min.js') %>
<% script('/main.js') %>
<% stylesheet('/styles.css') %>

<h1><%= message %></h1>
<a id="add-product-link" href="javascript:void(0);">Add Product</a>
<div id="products"></div>
<div id="modal-dialog">
	<fieldset>
		<legend><%= legend %></legend>
		<form action="/api/products/add" id="new-product-form" method="post">
			<label for="name">Product name:</label>
			<input type="text" name="name" id="name" />
			<label for="price">Product price:</label>
			<input type="text" id="price" name="price" />			
			<input type="submit" value="<%= saveText %>" />
			<input type="button" id="cancelButton" value="cancel" />
		</form>
	</fieldset>
</div>
<div id="modal-confirm-dialog">
	<form action="/api/products/remove" id="remove-product-form">
		<p id="form-info"></p>
		<input type="hidden" name="id" id="id" />
		<input type="hidden" name="rev" id="rev" />		
		<input type="submit" value="remove" />
		<input type="button" id="cancelRemoveAction" value="cancel" />
	</form>
</div>
<script type="text/javascript">
	function handleResponse(response) {
		for (var i = 0; i < response.length; i++) {
			var item = $('<div />', {'class': 'entry'});

			$('<p />', {html: '<strong>Product Name:</strong> ' + response[i].value.name + ' UAH'}).appendTo(item);
			$('<p />', {html: '<strong>Product Price:</strong> ' + response[i].value.price + ' UAH'}).appendTo(item);

			var p = $('<p />');
			$('<a />', {
				id: response[i].value.id, 
				text: 'edit', 
				href: 'javascript:void(0);',
				'class': 'edit-prod'
			}).appendTo(p);
			$('<a />', {
				id: response[i].value.id, 
				text: 'remove', 
				href: 'javascript:void(0);',
				'class': 'remv-prod'
			}).appendTo(p);

			p.appendTo(item);
			item.appendTo('#products');
		}
	}

	$.ajax({
		type: 'GET',
		url: '/api/products/list/',
		data: {},
		cache: false,
		success: function(response) {
			if (response.hasOwnProperty('error')) {
				var reason = response.hasOwnProperty('reason') ? response.reason : 'unknown';
				$('#products').css({color: 'Red'}).html('Error occurred on the server. Reason: ' + reason);				
			} else {
				handleResponse(response);
			}
		}
	});

	$('#add-product-link').click(function() {
		$('#modal-dialog').center().fadeIn();

		return false;
	});

	$('#new-product-form').submit(function() {
		$.ajax({
			type: 'POST',
			data: $(this).serialize(),
			url: $(this).attr('action'),
			cache: false,
			success: function(res) {
				if (res.error) {
					if (res.error.error && res.error.reason)
						$('#products').css({color: 'Red'}).html('Error occurred: ' + res.error.error + ', reason ' + res.error.reason);
				}
				if (res.location) {
					$.ajax({
						type: 'GET',
						cache: false,
						url: res.location,
						data: {},
						success: function(response) {
							if (response.hasOwnProperty('error')) {
								var reason = response.hasOwnProperty('reason') ? response.reason : 'unknown';
								$('#products').css({color: 'Red'}).html('Error occurred on the server. Reason: ' + reason);			
							} else {
								handleResponse(response);
							}
						}
					});
				}
			}
		});
	
		return false;
	});	

	$('a.remv-prod').live('click', function() {
		$.ajax({
			type: 'GET',
			url: '/api/products/get/' + $(this).attr('id'),
			cache: false,
			success: function(res) {
				$('#id').val(res._id);
				$('#rev').val(res._rev);
				$('#form-info').text('Are you sure you want to remove product: ' + res.name + ' with price ' + res.price);
				$('#modal-confirm-dialog').center().fadeIn();
			}
		});

		return false;
	});

	$('#remove-product-form').submit(function() {
		$.ajax({
			type: 'POST',
			url: $(this).attr('action'),
			data: $(this).serialize(),
			success: function(response) {
				if (response.error) {
					$('#products').css({color: 'Red'}).html('Error occurred on the server: ' + response.error.error + '. Reason: ' + response.error.reason);		
				}

				alert('deleted');
			}
		});

		return false;
	});

	$('#cancelButton').click(function() {
		$('#modal-dialog').fadeOut();
	});

	$('#cancelRemoveAction').click(function() {
		$('#modal-confirm-dialog').fadeOut();
	});
</script>

<% block('header', '') %>
<% block('footer', '') %>